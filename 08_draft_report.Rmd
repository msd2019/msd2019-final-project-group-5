---
title: "08_draft_report"
author: "Jiayi Lily Ma (jm4303), Lina Tian (yt2511), and Wen Ding (wd2288)"
date: "5/10/2019"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(here)
library(dyn)
#detach("package:dplyr", unload=TRUE) #unload dplyr if necessary because it interferes with dyn
source("oosf_new.R")
knitr::opts_chunk$set(echo = TRUE)
```

# Part 1: Paper's code
**The models they used:**  

* base model reg0 is $y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-12}$  
* Trend model reg1 is $y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-12} + \beta_3suvs + \beta_4insurance$  

**The out of sample forcasting method they used:**  

* Rolling window forecast: Starting from the 18th month in the data, they use all the previous months to train a model and predict the next month.  
* function to use in oosf.R: OutOfSampleForecast12()  

## 1.1 Create function for model and evaluation using their out of sample forecast functions
```{r create-paper-function}
#paper's code wrapped in function format
#data input should have date format mm/dd/y
#data columns should be: date, sales, suvs, insurance
getModelandEvaluation <- function(data, print=1, plot_title = "log(sales) over time") {
  zooObj <- zoo(data[,-1], as.Date(data[,1]))
  y <- log(zooObj$sales)
  x <- zooObj[, c("suvs", "insurance")]
  
  reg0 <- dyn$lm(y~lag(y,-1) + lag(y, -12))
  reg1 <- dyn$lm(y~lag(y,-1)+lag(y,-12)+suvs+insurance,data=data)
  
  if(print == 1){
    print("Summary of base model")
    print(summary(reg0))
    print("Summary of trend model")
    print(summary(reg1))
  }
  
  z <- OutOfSampleForecast12(y,x,17)
  print(MaeReport(z, plot_title = plot_title))
}

```

## 1.2 Paper's code, paper's data
```{r paper-code-paper-data}
dat <- read.csv("data/merged.csv")
getModelandEvaluation(dat, plot_title = "paper code paper data")
```

## 1.3 Paper's code, our data 
### 1.3.1 2014-2019
```{r paper-code-14-19-data}
merged1419 <- read.csv("data/merged_14_19.csv")
getModelandEvaluation(merged1419, plot_title = "paper code 2014-2019 data")
```



#### 1.3.1.1 Rescale Google trend's 2014-2019 data using log(x)/100
**1.3.1.1 Motivation:**  

* Using the code and data from the paper, we are able to reproduced the exact results that the authors had. But if we put in data from 2014 (March) - 2019 (February), we observe that the signs and significance of the coefficients changed. Also, the MAE increased rather than decreased when adding in Google Trend's data. For the data from the paper, however, the MAE decreased when Trend data are added.  
* We suspect that this discrepancy might be caused by the rescaling of Google Trend data in the paper, so we rescale the data here, using **$log(x)/100$** to check.  

```{r paper-code-14-19-rescaled-data}
#2014-2019
rescaled_merged1419 <- merged1419
rescaled_merged1419$suvs <- log(merged1419$suvs/100)
rescaled_merged1419$insurance <- log(merged1419$insurance/100)

head(rescaled_merged1419)
getModelandEvaluation(rescaled_merged1419, plot_title = "paper code rescaled 2014-2019 data")
```
**1.3.1.1 Observations: **  

* The signs of the coefficients are still different from the paper's, and the MAE also increased, although a bit less than before.  
* It could be that what the paper discovered, i.e. using Google Trend's data will help increase prediction accuracy (thus decrease overall MAE), applies to earlier years during which the data for this paper came from. The paper uses data from 2004-2011. Here, we examine the Trend data that we retrieved by following the directions from the paper for years 2009 (january) - 2013 (december) and 2004 (january) - 2008 (december). Note now Google only provides weekly data in 5 year ranges, and it's impossible to combine two five-year range datasets because Google normalizes the data against those in the range that we ask for; in other words, different data in different time ranges are normalized differently.  

### 1.3.2 2009-2013 unscaled and rescaled
```{r paper-code-09-13-data}
#unscaled 
merged0913 <- read.csv("data/merged_09_13.csv")
getModelandEvaluation(merged0913, plot_title = "paper code 2009-2013 data")

#recaled Trend data
rescaled_merged0913 <- merged0913
rescaled_merged0913$suvs <- log(merged0913$suvs/100)
rescaled_merged0913$insurance <- log(merged0913$insurance/100)

getModelandEvaluation(rescaled_merged0913, plot_title = "paper code rescaled 2009-2013 data")
```
**1.3.2 Observations:**  

* The increase in MAE is even more significant than previous with addition of Trend data in both cases; the coefficients and their signs are different from those from the paper too.   

### 1.3.3 2004-2008 unscaled and rescaled
```{r paper-code-04-08-data}
#unscaled
merged0408 <- read.csv("data/merged_04_08.csv")
getModelandEvaluation(merged0408, plot_title = "paper code 2004-2008 data")

#2004-2008 rescaled 
rescaled_merged0408 <- merged0408
rescaled_merged0408$suvs <- log(merged0408$suvs/100)
rescaled_merged0408$insurance <- log(merged0408$insurance/100)
#head(rescaled_merged0408)
getModelandEvaluation(rescaled_merged0408, plot_title = "paper code rescaled 2004-2008 data")
```
**1.3.3 Observations:**  

* Interestingly, if we use the data we found for years 2004-2008, we are able to reproduce similar results in the paper. Although the coefficients are different, the signs are the same; the significance of each predictor is similar too, except for insurance which is not signifcant here. Furthermore, we found that MAE decreased by a similar amount, i.e. about 10% with the addition of Trend data. Finally, the $R^2$ value is close to the paper's.  
* Then, we rescale Google Trend's data to see if we could get results even closer to the paper's:  
  + We see about the same result overall as the data that wasn't rescaled in terms of similarity to the original paper. That said, the decrease in MAE with the addition of Trend data and the $R^2$ value are a bit closer to the paper's.  
  + We see that our previous speculation was correct: the addition with Google Trend's data helps with prediction in the sense that we observe an overall decrease in MAE is only true for certain years, specifically, years before 2008.  

# Part 2: Our code
**The models we used (same as theirs):**  

* base model reg0 is $y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-12}$  
* Trend model reg1 is $y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-12} + \beta_3suvs + \beta_4insurance$  

**The out of sample forcasting method we used:**  

* Moving window forecast: Starting from the 18th month in the data, we use only the previous 17 months (1.5 years), instead of all the previous months, to train a model and predict the next month.  
* function to use in oosf.R: OutOfSampleForecast0112_mw()  

## 2.1 Create function for model and evaluation using our new out of sample forecast functions
```{r create-our-function}
getEvaluation_0112mv <- function(data, plot_title = "log(sales) over time"){
  zooObj <- zoo(data[,-1], as.Date(data[,1]))
  y <- log(zooObj$sales)
  x <- zooObj[, c("suvs", "insurance")]
  z <- OutOfSampleForecast0112_mw(y,x,17)
  MaeReport(z, plot_title = plot_title)
}
```

## 2.2 Our code, paper's data
```{r our-code-paper-data, message=FALSE}
attach(mtcars)
par(mfrow=c(2,1))
getEvaluation_0112mv(dat, plot_title = "our code paper data") # recall dat is the data in merged.csv
#compare MAE from rolling window
getModelandEvaluation(dat, print=0, plot_title = "paper code paper data") #default print = 1 prints model summary 
```
**2.2 Observations:**  

* We see that the MAE values are similar to the paper's, off by 0.5%. Note that the base model was also trained using moving window.  

## 2.3 Our code, our (scaled) data
Now we'll use our oosf on the data (rescaled) we retrieved, and compare them to the model we get using their code
```{r our-code-our-data, message=FALSE}
# 2014-2019 data
attach(mtcars)
par(mfrow=c(2,1))
getEvaluation_0112mv(rescaled_merged1419, plot_title = "our code rescaled 2014-2019 data")
getModelandEvaluation(rescaled_merged1419, print = 0, plot_title = "paper code rescaled 2014-2019 data")
# 2009-2013 data
attach(mtcars)
par(mfrow=c(2,1))
getEvaluation_0112mv(rescaled_merged0913, plot_title = "our code rescaled 2009-2013 data")
getModelandEvaluation(rescaled_merged0913, print = 0,  plot_title = "paper code rescaled 2009-2013 data")
#2004-2008 data
attach(mtcars)
par(mfrow=c(2,1))
getEvaluation_0112mv(rescaled_merged0408, plot_title = "our code rescaled 2004-2008 data")
getModelandEvaluation(rescaled_merged0408, print = 0, plot_title = "paper code rescaled 2004-2008 data")
```
**2.3 Observations:**  

* Using moving window out of sample forecast gave similar results as rolling window. For years after 2008, Trend data doesn't help to decrease MAE, but rather increase it. But before 2008, Trend data does decrease MAE. Note that using moving window, MAE decreased for the data from 2004-2008, but only about half as much as rolling window forecast.  


## 2.4 Trying a different model

* Instead of just looking at sales from the previous month and year, we also consider sales from three months, or one season. Our base model reg0 becomes $\mathbf{y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-3} + \beta_3y_{t-12}}$ and our Trend model reg1 becomes $\mathbf{y = \beta_0 + \beta_1y_{t-1} + \beta_2y_{t-3} + \beta_3y_{t-12} + \beta_4suvs + \beta_5insurance}$. We suspected that this would not give us a reliable model because we're using several predictors which are correlated and have very little data. Experimentation confirmed this.  
* Another possibility would be to try a completely different model.  


